<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Calendar Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.8/main.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.8/index.global.min.js"></script>
    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .btn {
            background-color: #3399ff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        .btn:hover {
            background-color: #2673cc;
        }
        
        .btn-danger {
            background-color: #dc3545;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .event-details {
            margin-bottom: 15px;
        }
        
        .event-details h3 {
            margin-top: 0;
            color: #333;
        }
        
        .event-details p {
            margin: 5px 0;
        }
        
        .priority-high { color: #dc3545; font-weight: bold; }
        .priority-medium { color: #ffc107; font-weight: bold; }
        .priority-low { color: #28a745; font-weight: bold; }
    </style>
</head>
<body>
    <header>
        <h1>Tasks & Events Dashboard</h1>
        <div class="menu-bar">
            <a href="/dashboard">Dashboard</a>
            <a href="/add_item/event">Event Form</a>
            <a href="/add_item/task">Task Form</a>
            <a href="/calendar">Calendar Dashboard</a>
            <a href="/analytics">View Analytics</a>
            <a href="/logout">Log Out</a>
        </div>
    </header>

    <div class="container">
        <h2>Calendar Dashboard</h2>
        <div id="full-calendar" class="calendar" style="width:100%; height:700px;"></div>
    </div>

    <!-- Event Details Modal -->
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="eventDetails">
                <!-- Event details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Edit Event Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Edit Event/Task</h3>
            <form id="editForm">
                <input type="hidden" id="editId">
                <div class="form-group">
                    <label for="editTitle">Title:</label>
                    <input type="text" id="editTitle" required>
                </div>
                <div class="form-group">
                    <label for="editDate">Date & Time:</label>
                    <input type="datetime-local" id="editDate" required>
                </div>
                <div class="form-group">
                    <label for="editCategory">Category:</label>
                    <select id="editCategory">
                        <option value="Misc">Misc</option>
                        <option value="Work">Work</option>
                        <option value="School">School</option>
                        <option value="Home">Home</option>
                        <option value="Vehicle">Vehicle</option>
                        <option value="Bills">Bills</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editPriority">Priority:</label>
                    <select id="editPriority">
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editRepeat">Repeat Interval:</label>
                    <select id="editRepeat">
                        <option value="none">None</option>
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editNotes">Notes:</label>
                    <textarea id="editNotes" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="editColor">Color:</label>
                    <input type="color" id="editColor">
                </div>
                <button type="submit" class="btn">Update</button>
                <button type="button" class="btn btn-danger" id="deleteBtn">Delete</button>
                <button type="button" class="btn" onclick="closeEditModal()">Cancel</button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const calendarEl = document.getElementById('full-calendar');
            const eventModal = document.getElementById('eventModal');
            const editModal = document.getElementById('editModal');
            const closeButtons = document.querySelectorAll('.close');

            let calendar;

            if (calendarEl) {
                calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
                    },
                    editable: true,
                    selectable: true,
                    selectMirror: true,
                    navLinks: true,
                    eventResizableFromStart: true,
                    eventSources: [{
                        url: '/api/events',
                        method: 'GET',
                        failure: function() {
                            alert('Error fetching events');
                        }
                    }],
                    select: function(info) {
                        const title = prompt('Enter event title:');
                        if (title) {
                            const eventData = {
                                title: title,
                                type: 'event',
                                start: info.startStr,
                                color: "#3399ff",
                                category: "Misc",
                                priority: "Medium",
                                notes: ""
                            };
                            
                            fetch('/api/events', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify(eventData)
                            })
                            .then(response => response.json())
                            .then(data => {
                                calendar.addEvent({
                                    id: data.id,
                                    title: title,
                                    start: info.startStr,
                                    allDay: info.allDay,
                                    color: "#3399ff"
                                });
                            })
                            .catch(() => alert('Failed to create event'));
                        }
                        calendar.unselect();
                    },
                    eventClick: function(info) {
                        showEventDetails(info.event);
                    },
                    eventDrop: function(info) {
                        updateEventDate(info.event.id, info.event.start.toISOString(), info);
                    },
                    eventResize: function(info) {
                        updateEventDate(info.event.id, info.event.start.toISOString(), info);
                    }
                });
                calendar.render();
            }

            // Close modal handlers
            closeButtons.forEach(button => {
                button.onclick = function() {
                    eventModal.style.display = 'none';
                    editModal.style.display = 'none';
                }
            });

            // Close modals when clicking outside
            window.onclick = function(event) {
                if (event.target === eventModal) {
                    eventModal.style.display = 'none';
                }
                if (event.target === editModal) {
                    editModal.style.display = 'none';
                }
            }

            // Show event details
            function showEventDetails(event) {
                fetch(`/api/events/${event.id}`)
                    .then(response => response.json())
                    .then(data => {
                        const priorityClass = `priority-${data.priority.toLowerCase()}`;
                        const statusBadge = data.status === 'completed' ? '<span style="color: green;">✅ Completed</span>' : '<span style="color: orange;">⏳ Pending</span>';
                        const repeatText = data.repeat_interval !== 'none' ? ` (Repeats ${data.repeat_interval})` : '';
                        
                        document.getElementById('eventDetails').innerHTML = `
                            <div class="event-details">
                                <h3>${data.name}${repeatText}</h3>
                                <p><strong>Type:</strong> ${data.type.charAt(0).toUpperCase() + data.type.slice(1)}</p>
                                <p><strong>Due Date:</strong> ${new Date(data.due_date).toLocaleString()}</p>
                                <p><strong>Status:</strong> ${statusBadge}</p>
                                <p><strong>Priority:</strong> <span class="${priorityClass}">${data.priority}</span></p>
                                <p><strong>Category:</strong> ${data.category}</p>
                                ${data.repeat_interval !== 'none' ? `<p><strong>Repeats:</strong> ${data.repeat_interval}</p>` : ''}
                                ${data.mention ? `<p><strong>Mention:</strong> ${data.mention}</p>` : ''}
                                ${data.notes ? `<p><strong>Notes:</strong> ${data.notes}</p>` : ''}
                            </div>
                            <button class="btn" onclick="editEvent(${data.id})">Edit</button>
                            <button class="btn" onclick="toggleComplete(${data.id}, '${data.status}')">
                                ${data.status === 'completed' ? 'Mark Incomplete' : 'Mark Complete'}
                            </button>
                            <button class="btn btn-danger" onclick="deleteEvent(${data.id})">Delete</button>
                        `;
                        eventModal.style.display = 'block';
                    })
                    .catch(() => alert('Failed to load event details'));
            }

            // Edit event
            window.editEvent = function(eventId) {
                fetch(`/api/events/${eventId}`)
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('editId').value = data.id;
                        document.getElementById('editTitle').value = data.name;
                        
                        // Format date for datetime-local input
                        const date = new Date(data.due_date);
                        const formattedDate = date.toISOString().slice(0, 16);
                        document.getElementById('editDate').value = formattedDate;
                        
                        document.getElementById('editCategory').value = data.category;
                        document.getElementById('editPriority').value = data.priority;
                        document.getElementById('editRepeat').value = data.repeat_interval || 'none';
                        document.getElementById('editNotes').value = data.notes || '';
                        document.getElementById('editColor').value = data.color || '#3399ff';
                        
                        eventModal.style.display = 'none';
                        editModal.style.display = 'block';
                    });
            }

            // Close edit modal
            window.closeEditModal = function() {
                editModal.style.display = 'none';
            }

            // Handle edit form submission
            document.getElementById('editForm').onsubmit = function(e) {
                e.preventDefault();
                
                const eventId = document.getElementById('editId').value;
                const updateData = {
                    name: document.getElementById('editTitle').value,
                    due_date: new Date(document.getElementById('editDate').value).toISOString(),
                    category: document.getElementById('editCategory').value,
                    priority: document.getElementById('editPriority').value,
                    notes: document.getElementById('editNotes').value,
                    repeat_interval: document.getElementById('editRepeat').value,
                    color: document.getElementById('editColor').value
                };

                fetch(`/api/events/${eventId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(updateData)
                })
                .then(response => response.json())
                .then(() => {
                    editModal.style.display = 'none';
                    calendar.refetchEvents();
                    alert('Event updated successfully! Recurring instances will be regenerated.');
                })
                .catch(() => alert('Failed to update event'));
            }

            // Delete event
            document.getElementById('deleteBtn').onclick = function() {
                const eventId = document.getElementById('editId').value;
                if (confirm('Are you sure you want to delete this event?')) {
                    deleteEvent(eventId);
                }
            }

            // Toggle complete status
            window.toggleComplete = function(eventId, currentStatus) {
                const newStatus = currentStatus === 'completed' ? 'pending' : 'completed';
                
                fetch(`/api/events/${eventId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({status: newStatus})
                })
                .then(response => response.json())
                .then(() => {
                    eventModal.style.display = 'none';
                    calendar.refetchEvents();
                    alert(`Event marked as ${newStatus}!`);
                })
                .catch(() => alert('Failed to update status'));
            }

            // Delete event
            window.deleteEvent = function(eventId) {
                if (confirm('Are you sure you want to delete this event?')) {
                    fetch(`/api/events/${eventId}`, {
                        method: 'DELETE'
                    })
                    .then(response => response.json())
                    .then(() => {
                        eventModal.style.display = 'none';
                        editModal.style.display = 'none';
                        calendar.refetchEvents();
                        alert('Event deleted successfully!');
                    })
                    .catch(() => alert('Failed to delete event'));
                }
            }

            // Update event date (for drag and drop)
            function updateEventDate(eventId, newDate, info) {
                fetch(`/api/events/${eventId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({due_date: newDate})
                })
                .then(response => {
                    if (!response.ok) {
                        info.revert();
                        alert('Failed to update event date');
                    }
                })
                .catch(() => {
                    info.revert();
                    alert('Failed to update event date');
                });
            }
        });
    </script>
</body>
</html>