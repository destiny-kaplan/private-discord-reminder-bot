<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        .analytics-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .chart-container h3 {
            margin-top: 0;
            text-align: center;
            color: #333;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #3399ff;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .priority-high { color: #dc3545; }
        .priority-medium { color: #ffc107; }
        .priority-low { color: #28a745; }
        
        canvas {
            max-height: 300px;
        }
        
        .filter-controls {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-controls select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            text-align: center;
            padding: 40px;
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <header>
        <h1>Tasks & Events Dashboard</h1>
        <div class="menu-bar">
            <a href="/dashboard">Dashboard</a>
            <a href="/add_item/event">Event Form</a>
            <a href="/add_item/task">Task Form</a>
            <a href="/calendar">Calendar Dashboard</a>
            <a href="/analytics">View Analytics</a>
            <a href="/logout">Log Out</a>
        </div>
    </header>

    <div class="container">
        <h2>ðŸ“Š Analytics Dashboard</h2>
        
        <div class="filter-controls">
            <label for="timeFilter">Time Range:</label>
            <select id="timeFilter">
                <option value="all">All Time</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
                <option value="quarter">This Quarter</option>
            </select>
            
            <label for="typeFilter">Type:</label>
            <select id="typeFilter">
                <option value="all">All Types</option>
                <option value="task">Tasks Only</option>
                <option value="event">Events Only</option>
            </select>
            
            <button onclick="updateCharts()" style="padding: 8px 15px; background-color: #3399ff; color: white; border: none; border-radius: 4px; cursor: pointer;">Update Charts</button>
        </div>
        
        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalItems">-</div>
                <div class="stat-label">Total Items</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completedItems" style="color: #28a745;">-</div>
                <div class="stat-label">Completed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingItems" style="color: #ffc107;">-</div>
                <div class="stat-label">Pending</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="overdueItems" style="color: #dc3545;">-</div>
                <div class="stat-label">Overdue</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completionRate" style="color: #17a2b8;">-</div>
                <div class="stat-label">Completion Rate</div>
            </div>
        </div>
        
        <!-- Loading/Error Messages -->
        <div id="loadingMessage" class="loading" style="display: none;">
            Loading analytics data...
        </div>
        
        <div id="errorMessage" class="error" style="display: none;">
            Error loading analytics data. Please refresh the page.
        </div>
        
        <!-- Charts -->
        <div class="analytics-container">
            <div class="chart-container">
                <h3>Tasks & Events by Category</h3>
                <canvas id="categoryChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3>Priority Distribution</h3>
                <canvas id="priorityChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3>Completion Status</h3>
                <canvas id="statusChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3>Items Over Time</h3>
                <canvas id="timeChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let charts = {};

        document.addEventListener('DOMContentLoaded', function() {
            loadData();
        });

        function showLoading() {
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loadingMessage').style.display = 'none';
        }

        function showError() {
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('loadingMessage').style.display = 'none';
        }

        function loadData() {
            showLoading();
            fetch('/api/events')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    allData = data;
                    hideLoading();
                    updateStats();
                    createCharts();
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                    hideLoading();
                    showError();
                });
        }

        function updateStats() {
            const data = getFilteredData();
            const now = new Date();
            
            const total = data.length;
            const completed = data.filter(item => item.extendedProps && item.extendedProps.status === 'completed').length;
            const pending = data.filter(item => !item.extendedProps || item.extendedProps.status === 'pending').length;
            const overdue = data.filter(item => {
                if (item.extendedProps && item.extendedProps.status === 'completed') return false;
                return new Date(item.start) < now;
            }).length;
            
            const completionRate = total > 0 ? Math.round((completed / total) * 100) : 0;

            document.getElementById('totalItems').textContent = total;
            document.getElementById('completedItems').textContent = completed;
            document.getElementById('pendingItems').textContent = pending;
            document.getElementById('overdueItems').textContent = overdue;
            document.getElementById('completionRate').textContent = completionRate + '%';
        }

        function getFilteredData() {
            let filtered = [...allData];
            
            const timeFilter = document.getElementById('timeFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            
            // Apply type filter
            if (typeFilter !== 'all') {
                filtered = filtered.filter(item => item.extendedProps && item.extendedProps.type === typeFilter);
            }
            
            // Apply time filter
            if (timeFilter !== 'all') {
                const now = new Date();
                let startDate;
                
                switch(timeFilter) {
                    case 'week':
                        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
                        break;
                    case 'month':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        break;
                    case 'quarter':
                        startDate = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
                        break;
                }
                
                if (startDate) {
                    filtered = filtered.filter(item => new Date(item.start) >= startDate);
                }
            }
            
            return filtered;
        }

        function createCharts() {
            createCategoryChart();
            createPriorityChart();
            createStatusChart();
            createTimeChart();
        }

        function createCategoryChart() {
            const data = getFilteredData();
            const categories = {};
            
            data.forEach(item => {
                const category = (item.extendedProps && item.extendedProps.category) || 'Misc';
                categories[category] = (categories[category] || 0) + 1;
            });

            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            if (charts.category) {
                charts.category.destroy();
            }
            
            charts.category = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categories),
                    datasets: [{
                        data: Object.values(categories),
                        backgroundColor: [
                            '#3399ff',
                            '#28a745',
                            '#ffc107',
                            '#dc3545',
                            '#17a2b8',
                            '#6f42c1',
                            '#fd7e14'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createPriorityChart() {
            const data = getFilteredData();
            const priorities = { Low: 0, Medium: 0, High: 0 };
            
            data.forEach(item => {
                const priority = (item.extendedProps && item.extendedProps.priority) || 'Medium';
                if (priorities.hasOwnProperty(priority)) {
                    priorities[priority]++;
                }
            });

            const ctx = document.getElementById('priorityChart').getContext('2d');
            
            if (charts.priority) {
                charts.priority.destroy();
            }
            
            charts.priority = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Low', 'Medium', 'High'],
                    datasets: [{
                        label: 'Count',
                        data: [priorities.Low, priorities.Medium, priorities.High],
                        backgroundColor: ['#28a745', '#ffc107', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function createStatusChart() {
            const data = getFilteredData();
            const statuses = { pending: 0, completed: 0 };
            
            data.forEach(item => {
                const status = (item.extendedProps && item.extendedProps.status) || 'pending';
                if (statuses.hasOwnProperty(status)) {
                    statuses[status]++;
                }
            });

            const ctx = document.getElementById('statusChart').getContext('2d');
            
            if (charts.status) {
                charts.status.destroy();
            }
            
            charts.status = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Pending', 'Completed'],
                    datasets: [{
                        data: [statuses.pending, statuses.completed],
                        backgroundColor: ['#ffc107', '#28a745']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createTimeChart() {
            const data = getFilteredData();
            const timeData = {};
            
            // Group by month
            data.forEach(item => {
                const date = new Date(item.start);
                if (!isNaN(date.getTime())) {
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    timeData[monthKey] = (timeData[monthKey] || 0) + 1;
                }
            });
            
            // Sort by date and get last 12 months or all available data
            const sortedMonths = Object.keys(timeData).sort();
            const recentMonths = sortedMonths.slice(-12);
            const counts = recentMonths.map(month => timeData[month]);
            
            // Format labels
            const labels = recentMonths.map(month => {
                const [year, monthNum] = month.split('-');
                const date = new Date(year, monthNum - 1);
                return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            });

            const ctx = document.getElementById('timeChart').getContext('2d');
            
            if (charts.time) {
                charts.time.destroy();
            }
            
            charts.time = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Items Created',
                        data: counts,
                        borderColor: '#3399ff',
                        backgroundColor: 'rgba(51, 153, 255, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function updateCharts() {
            updateStats();
            createCharts();
        }

        // Auto-refresh every 30 seconds
        setInterval(() => {
            loadData();
        }, 30000);
    </script>
</body>
</html>